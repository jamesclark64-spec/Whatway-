<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Cartoon Compass Arrow to a Capital</title>

  <!-- Leaflet (map) -->
  <link rel="stylesheet"
        href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
        crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
          integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
          crossorigin=""></script>

  <style>
    :root{
      color-scheme: light dark;
      --outline: rgba(0,0,0,.18);
      --card: rgba(255,255,255,.72);
      --cardDark: rgba(20,20,24,.50);
      --shadow: 0 14px 30px rgba(0,0,0,.18);
      --popShadow: 0 10px 0 rgba(0,0,0,.12);
    }

    body{
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      margin:0;
      padding:14px;
      display:grid;
      gap:12px;
      max-width: 900px;
      margin-inline:auto;

      /* cartoony background */
      background:
        radial-gradient(circle at 15% 20%, rgba(255, 196, 92, .35), transparent 40%),
        radial-gradient(circle at 80% 15%, rgba(115, 232, 255, .30), transparent 45%),
        radial-gradient(circle at 25% 85%, rgba(255, 120, 214, .25), transparent 40%),
        radial-gradient(circle at 85% 85%, rgba(139, 255, 170, .25), transparent 42%),
        linear-gradient(135deg, rgba(255,255,255,.08), rgba(255,255,255,0));
    }

    h1{
      margin:0;
      font-size:18px;
      letter-spacing: .2px;
    }

    .card{
      border: 3px solid rgba(0,0,0,.12);
      border-radius: 18px;
      padding: 14px;
      display:grid;
      gap:12px;
      box-shadow: var(--shadow);
      background: var(--card);
      backdrop-filter: blur(6px);
    }
    @media (prefers-color-scheme: dark){
      .card{ background: var(--cardDark); border-color: rgba(255,255,255,.12); }
    }

    label{ font-size:12px; opacity:.85; }

    select, button{
      font: inherit;
      padding: 11px 12px;
      border-radius: 14px;
      border: 3px solid rgba(0,0,0,.14);
      background: rgba(255,255,255,.55);
      box-shadow: var(--popShadow);
    }
    @media (prefers-color-scheme: dark){
      select, button{
        background: rgba(30,30,34,.55);
        border-color: rgba(255,255,255,.14);
        box-shadow: 0 10px 0 rgba(0,0,0,.28);
      }
    }

    button{ cursor:pointer; user-select:none; }
    button:active{ transform: translateY(2px); box-shadow: 0 8px 0 rgba(0,0,0,.12); }

    .row{ display:grid; gap:8px; }
    .row.inline{ grid-template-columns: 1fr auto auto; gap:8px; align-items:end; }
    @media (max-width: 720px){
      .row.inline{ grid-template-columns: 1fr; }
    }

    .muted{ font-size:12px; opacity:.8; }
    .warn{ color: #b00020; font-weight: 700; }
    .ok{ color: #0a7a2b; font-weight: 700; }

    /* Map */
    #map{
      width:100%;
      height: 340px;
      border-radius: 18px;
      overflow:hidden;
      border: 3px solid rgba(0,0,0,.12);
      box-shadow: inset 0 0 0 2px rgba(255,255,255,.25);
    }

    /* Stats grid */
    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    @media (max-width: 720px){
      .grid2{ grid-template-columns: 1fr; }
    }
    .pill{
      border: 3px solid rgba(0,0,0,.12);
      border-radius: 16px;
      padding: 10px 12px;
      background: rgba(255,255,255,.45);
      box-shadow: var(--popShadow);
      display:grid;
      gap:6px;
    }
    @media (prefers-color-scheme: dark){
      .pill{ background: rgba(30,30,34,.45); border-color: rgba(255,255,255,.12); }
    }

    .big{
      font-size: 18px;
      font-weight: 900;
      font-variant-numeric: tabular-nums;
      letter-spacing: .2px;
    }

    /* Arrow + compass dial */
    .arrowWrap{
      display:grid;
      place-items:center;
      min-height: 260px;
      position:relative;
      border-radius: 18px;
      border: 3px solid rgba(0,0,0,.12);
      background:
        radial-gradient(circle at center, rgba(255,255,255,.55), rgba(255,255,255,.12)),
        repeating-conic-gradient(from 0deg,
          rgba(0,0,0,.10) 0deg 2deg,
          transparent 2deg 15deg);
      box-shadow: inset 0 0 0 2px rgba(255,255,255,.25);
      overflow:hidden;
    }
    @media (prefers-color-scheme: dark){
      .arrowWrap{
        background:
          radial-gradient(circle at center, rgba(30,30,34,.55), rgba(30,30,34,.12)),
          repeating-conic-gradient(from 0deg,
            rgba(255,255,255,.10) 0deg 2deg,
            transparent 2deg 15deg);
        border-color: rgba(255,255,255,.12);
      }
    }

    .dialLabel{
      position:absolute;
      font-weight: 900;
      text-shadow: 0 2px 0 rgba(0,0,0,.10);
      user-select:none;
      opacity:.85;
    }
    .dialN{ top: 10px; }
    .dialS{ bottom: 10px; }
    .dialE{ right: 10px; }
    .dialW{ left: 10px; }

    .arrow{
      position:relative;
      width: 0;
      height: 0;

      /* thick cartoon arrow head */
      border-left: 30px solid transparent;
      border-right: 30px solid transparent;
      border-bottom: 150px solid currentColor;

      transform: rotate(0deg);
      transform-origin: 50% 86%;
      transition: transform 140ms linear;

      /* cartoon outline */
      filter:
        drop-shadow(0 12px 0 rgba(0,0,0,.10))
        drop-shadow(0 16px 24px rgba(0,0,0,.20));
    }
    .arrow::after{
      content:"";
      position:absolute;
      left:-12px;
      top:128px;
      width:24px;
      height:78px;
      background: currentColor;
      border-radius: 14px;
      box-shadow: 0 0 0 4px rgba(0,0,0,.10) inset;
    }

    .badgeRow{
      display:flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items:center;
    }
    .badge{
      border: 3px solid rgba(0,0,0,.12);
      border-radius: 999px;
      padding: 6px 10px;
      background: rgba(255,255,255,.45);
      box-shadow: 0 8px 0 rgba(0,0,0,.10);
      font-size: 12px;
      font-weight: 800;
      user-select:none;
    }
    @media (prefers-color-scheme: dark){
      .badge{ background: rgba(30,30,34,.45); border-color: rgba(255,255,255,.12); box-shadow: 0 8px 0 rgba(0,0,0,.28); }
    }

    .funList{
      margin:0;
      padding-left: 18px;
      display:grid;
      gap:6px;
    }
  </style>
</head>
<body>
  <h1>Cartoon Compass Arrow to a Capital</h1>

  <div class="card">
    <div class="row inline">
      <div class="row">
        <label for="city">Choose a capital city</label>
        <select id="city"></select>
      </div>

      <div class="row">
        <label>&nbsp;</label>
        <button id="locateBtn" type="button">üìç Locate me</button>
      </div>

      <div class="row">
        <label>&nbsp;</label>
        <button id="fitBtn" type="button">üó∫Ô∏è Fit map</button>
      </div>
    </div>

    <div class="badgeRow">
      <span class="badge" id="modeBadge">Mode: North-up</span>
      <button id="compassBtn" type="button" title="Enable compass/orientation">üß≠ Compass mode</button>
      <span class="muted" id="headingReadout">Heading: ‚Äî</span>
    </div>

    <div id="map" aria-label="Map"></div>

    <div class="grid2">
      <div class="pill">
        <div class="muted">Your location</div>
        <div id="you" class="big">Not located yet</div>
        <div id="acc" class="muted"></div>
      </div>
      <div class="pill">
        <div class="muted">Selected city</div>
        <div id="dest" class="big">‚Äî</div>
        <div id="destCoords" class="muted"></div>
      </div>
    </div>

    <div class="arrowWrap" aria-label="Compass dial">
      <div class="dialLabel dialN">N</div>
      <div class="dialLabel dialE">E</div>
      <div class="dialLabel dialS">S</div>
      <div class="dialLabel dialW">W</div>
      <div id="arrow" class="arrow" aria-label="Direction arrow"></div>
    </div>

    <div class="grid2">
      <div class="pill">
        <div class="muted">Distance</div>
        <div id="distance" class="big">‚Äî</div>
        <div class="muted">Great-circle (as the crow flies)</div>
      </div>
      <div class="pill">
        <div class="muted">Direction</div>
        <div id="bearing" class="big">‚Äî</div>
        <div id="compass" class="muted">‚Äî</div>
      </div>
    </div>

    <div class="pill">
      <div class="muted">Fun distance equivalents</div>
      <ul id="fun" class="funList"></ul>
    </div>

    <div id="msg" class="muted"></div>
  </div>

<script>
(() => {
  // Capitals (edit freely)
  const capitals = [
    { name: "London, UK",          lat: 51.5074, lon: -0.1278 },
    { name: "Paris, France",       lat: 48.8566, lon:  2.3522 },
    { name: "Washington DC, USA",  lat: 38.9072, lon: -77.0369 },
    { name: "Tokyo, Japan",        lat: 35.6762, lon: 139.6503 },
    { name: "Canberra, Australia", lat: -35.2809, lon: 149.1300 },
    { name: "Ottawa, Canada",      lat: 45.4215, lon: -75.6972 }
  ];

  // Fun units (meters)
  const funUnits = [
    { label: "football pitches (105 m)", meters: 105 },
    { label: "London buses (11.2 m)", meters: 11.2 },
    { label: "Olympic track laps (400 m)", meters: 400 },
    { label: "Big Bens (96 m)", meters: 96 },
    { label: "Eiffel Towers (330 m)", meters: 330 },
    { label: "Tower Bridges (244 m)", meters: 244 }
  ];

  // Elements
  const elCity = document.getElementById("city");
  const elLocate = document.getElementById("locateBtn");
  const elFit = document.getElementById("fitBtn");
  const elCompassBtn = document.getElementById("compassBtn");
  const elModeBadge = document.getElementById("modeBadge");
  const elHeadingReadout = document.getElementById("headingReadout");

  const elArrow = document.getElementById("arrow");
  const elYou = document.getElementById("you");
  const elAcc = document.getElementById("acc");
  const elDest = document.getElementById("dest");
  const elDestCoords = document.getElementById("destCoords");
  const elDistance = document.getElementById("distance");
  const elBearing = document.getElementById("bearing");
  const elCompass = document.getElementById("compass");
  const elMsg = document.getElementById("msg");
  const elFun = document.getElementById("fun");

  // State
  let userPos = null; // {lat, lon, acc}
  let map, youMarker, destMarker, line;

  // Heading state (degrees from true north, 0..360)
  let compassEnabled = false;
  let headingDeg = null; // device heading (0..360)

  // --- Helpers ---
  function toRad(deg){ return deg * Math.PI / 180; }
  function toDeg(rad){ return rad * 180 / Math.PI; }

  function distanceM(lat1, lon1, lat2, lon2) {
    const R = 6371008.8;
    const œÜ1 = toRad(lat1), œÜ2 = toRad(lat2);
    const ŒîœÜ = toRad(lat2 - lat1);
    const ŒîŒª = toRad(lon2 - lon1);
    const a = Math.sin(ŒîœÜ/2)**2 + Math.cos(œÜ1)*Math.cos(œÜ2)*Math.sin(ŒîŒª/2)**2;
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
  }

  function bearingDeg(lat1, lon1, lat2, lon2) {
    const œÜ1 = toRad(lat1), œÜ2 = toRad(lat2);
    const Œª1 = toRad(lon1), Œª2 = toRad(lon2);
    const y = Math.sin(Œª2 - Œª1) * Math.cos(œÜ2);
    const x = Math.cos(œÜ1)*Math.sin(œÜ2) - Math.sin(œÜ1)*Math.cos(œÜ2)*Math.cos(Œª2 - Œª1);
    const Œ∏ = Math.atan2(y, x);
    return (toDeg(Œ∏) + 360) % 360;
  }

  function compassLabel(b) {
    const dirs = ["N","NNE","NE","ENE","E","ESE","SE","SSE","S","SSW","SW","WSW","W","WNW","NW","NNW"];
    const idx = Math.round(b / 22.5) % 16;
    return dirs[idx];
  }

  function formatCoord(lat, lon) {
    const ns = lat >= 0 ? "N" : "S";
    const ew = lon >= 0 ? "E" : "W";
    return `${Math.abs(lat).toFixed(5)}¬∞${ns}, ${Math.abs(lon).toFixed(5)}¬∞${ew}`;
  }

  function formatDistance(m) {
    if (m >= 1000000) return `${(m/1000).toFixed(0)} km`;
    if (m >= 10000)   return `${(m/1000).toFixed(1)} km`;
    if (m >= 1000)    return `${(m/1000).toFixed(2)} km`;
    return `${Math.round(m)} m`;
  }

  function niceCount(x){
    if (x >= 10000) return x.toFixed(0);
    if (x >= 1000)  return x.toFixed(0);
    if (x >= 100)   return x.toFixed(0);
    if (x >= 10)    return x.toFixed(1);
    return x.toFixed(2);
  }

  function setFunList(distanceMeters) {
    elFun.innerHTML = "";

    // Pick a set that reads nicely at all scales
    const picks = [
      funUnits.find(u => u.label.startsWith("London buses")),
      funUnits.find(u => u.label.startsWith("football pitches")),
      funUnits.find(u => u.label.startsWith("Tower Bridges")),
      funUnits.find(u => u.label.startsWith("Eiffel"))
    ].filter(Boolean);

    // If it's not massive, swap Eiffel for Big Ben for better vibes
    if (distanceMeters < 250000) {
      const bb = funUnits.find(u => u.label.startsWith("Big Bens"));
      if (bb) picks[picks.length - 1] = bb;
    }

    for (const u of picks) {
      const li = document.createElement("li");
      li.textContent = `${niceCount(distanceMeters / u.meters)} ${u.label}`;
      elFun.appendChild(li);
    }

    // Bonus travel-time sillies
    const planeHours = distanceMeters / 900000; // 900 km/h
    const walkDays = (distanceMeters / 5000) / 24; // 5 km/h
    const extra = document.createElement("li");
    extra.textContent = `~${planeHours.toFixed(1)} hours by jet (900 km/h), or ~${walkDays.toFixed(0)} days walking (5 km/h)`;
    elFun.appendChild(extra);
  }

  function normalize360(d){
    d = d % 360;
    return d < 0 ? d + 360 : d;
  }

  // --- Map ---
  function initMap() {
    map = L.map("map", { zoomControl: true }).setView([20, 0], 2);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    youMarker = L.marker([0,0]).addTo(map).bindPopup("You");
    destMarker = L.marker([0,0]).addTo(map).bindPopup("Destination");

    line = L.polyline([[0,0],[0,0]], { weight: 4, opacity: 0.85 }).addTo(map);
  }

  function fitMap() {
    if (!userPos) return;
    const dest = capitals[Number(elCity.value)];
    const bounds = L.latLngBounds(
      [userPos.lat, userPos.lon],
      [dest.lat, dest.lon]
    ).pad(0.25);
    map.fitBounds(bounds, { animate: true });
  }

  function updateMap() {
    const dest = capitals[Number(elCity.value)];
    destMarker.setLatLng([dest.lat, dest.lon]).setPopupContent(dest.name);

    if (!userPos) {
      youMarker.setLatLng([0,0]).setPopupContent("You (not located yet)");
      line.setLatLngs([[0,0],[0,0]]);
      return;
    }

    youMarker.setLatLng([userPos.lat, userPos.lon]).setPopupContent("You");
    line.setLatLngs([[userPos.lat, userPos.lon], [dest.lat, dest.lon]]);
  }

  // --- UI + arrow ---
  function setModeBadge() {
    if (compassEnabled && headingDeg != null) {
      elModeBadge.textContent = "Mode: Compass (relative)";
      elModeBadge.className = "badge ok";
    } else {
      elModeBadge.textContent = "Mode: North-up";
      elModeBadge.className = "badge";
    }
  }

  function updateArrow(bearingToTarget) {
    // North-up: arrow rotation = bearing
    // Compass mode: arrow rotation = bearing - deviceHeading
    let rotation = bearingToTarget;

    if (compassEnabled && headingDeg != null) {
      rotation = normalize360(bearingToTarget - headingDeg);
    }

    elArrow.style.transform = `rotate(${rotation}deg)`;
  }

  function updateUI() {
    const dest = capitals[Number(elCity.value)];
    elDest.textContent = dest.name;
    elDestCoords.textContent = formatCoord(dest.lat, dest.lon);

    updateMap();
    setModeBadge();

    if (!userPos) {
      elDistance.textContent = "‚Äî";
      elBearing.textContent = "‚Äî";
      elCompass.textContent = "‚Äî";
      elHeadingReadout.textContent = "Heading: ‚Äî";
      elFun.innerHTML = "";
      elMsg.innerHTML = `<span class="warn">Tap ‚ÄúLocate me‚Äù first, then (optional) enable compass mode.</span>`;
      updateArrow(0);
      return;
    }

    const distM = distanceM(userPos.lat, userPos.lon, dest.lat, dest.lon);
    const b = bearingDeg(userPos.lat, userPos.lon, dest.lat, dest.lon);

    elDistance.textContent = formatDistance(distM);
    elBearing.textContent = `${b.toFixed(1)}¬∞`;
    elCompass.textContent = `Bearing: ${compassLabel(b)} (${b.toFixed(1)}¬∞)`;

    elYou.textContent = formatCoord(userPos.lat, userPos.lon);
    elAcc.textContent = userPos.acc ? `Accuracy: ¬±${Math.round(userPos.acc)} m` : "";

    if (headingDeg == null) {
      elHeadingReadout.textContent = "Heading: ‚Äî";
    } else {
      elHeadingReadout.textContent = `Heading: ${headingDeg.toFixed(0)}¬∞ (${compassLabel(headingDeg)})`;
    }

    setFunList(distM);

    // Arrow rotation depends on compass mode
    updateArrow(b);

    // Message if compass requested but no data
    if (compassEnabled && headingDeg == null) {
      elMsg.innerHTML = `<span class="warn">Compass enabled, but no heading data yet. Try moving the phone in a figure-8, and ensure motion/compass permission is allowed.</span>`;
    } else {
      elMsg.textContent = "";
    }
  }

  // --- GPS ---
  function locate() {
    if (!navigator.geolocation) {
      elMsg.innerHTML = `<span class="warn">Geolocation isn‚Äôt supported on this device/browser.</span>`;
      return;
    }
    elMsg.textContent = "Requesting location‚Ä¶ (allow permission if asked)";

    navigator.geolocation.getCurrentPosition(
      (pos) => {
        userPos = {
          lat: pos.coords.latitude,
          lon: pos.coords.longitude,
          acc: pos.coords.accuracy
        };
        elMsg.textContent = "";
        map.setView([userPos.lat, userPos.lon], 12, { animate: true });
        updateUI();
      },
      (err) => {
        userPos = null;
        let text = "Couldn‚Äôt get location.";
        if (err.code === 1) text = "Location permission denied.";
        if (err.code === 2) text = "Location unavailable (try moving or turning GPS on).";
        if (err.code === 3) text = "Location request timed out (try again).";
        elMsg.innerHTML = `<span class="warn">${text}</span>`;
        updateUI();
      },
      { enableHighAccuracy: true, timeout: 12000, maximumAge: 0 }
    );
  }

  // --- Compass / heading ---
  function tryStartDeviceOrientation() {
    // Uses:
    // - iOS: event.webkitCompassHeading (degrees)
    // - Others: event.alpha (0..360) from DeviceOrientationEvent (often requires permission on iOS)
    function handler(ev) {
      // iOS Safari gives webkitCompassHeading (0=N)
      if (typeof ev.webkitCompassHeading === "number") {
        headingDeg = normalize360(ev.webkitCompassHeading);
      } else if (typeof ev.alpha === "number") {
        // On many Android devices: alpha is degrees clockwise from north (but can vary by implementation)
        // We'll treat it as 0..360 heading and normalize.
        headingDeg = normalize360(ev.alpha);
      } else {
        headingDeg = null;
      }
      updateUI();
    }

    // Keep only one listener
    window.removeEventListener("deviceorientationabsolute", handler, true);
    window.removeEventListener("deviceorientation", handler, true);

    // Prefer absolute when available
    if ("ondeviceorientationabsolute" in window) {
      window.addEventListener("deviceorientationabsolute", handler, true);
    } else {
      window.addEventListener("deviceorientation", handler, true);
    }
  }

  async function enableCompassMode() {
    compassEnabled = true;
    setModeBadge();
    elMsg.textContent = "";

    // iOS 13+ requires explicit permission request
    const DOE = window.DeviceOrientationEvent;
    if (DOE && typeof DOE.requestPermission === "function") {
      try {
        const res = await DOE.requestPermission();
        if (res !== "granted") {
          compassEnabled = false;
          headingDeg = null;
          elMsg.innerHTML = `<span class="warn">Motion/compass permission was not granted. Compass mode turned off.</span>`;
          updateUI();
          return;
        }
      } catch (e) {
        compassEnabled = false;
        headingDeg = null;
        elMsg.innerHTML = `<span class="warn">Couldn‚Äôt request motion permission. Compass mode turned off.</span>`;
        updateUI();
        return;
      }
    }

    tryStartDeviceOrientation();

    // Give a gentle hint
    elMsg.innerHTML = `<span class="muted">If the heading seems stuck, wave the phone in a figure-8 to help calibration.</span>`;
    updateUI();
  }

  function toggleCompass() {
    if (compassEnabled) {
      compassEnabled = false;
      headingDeg = null;
      elMsg.textContent = "Compass mode off (north-up).";
      updateUI();
      return;
    }
    enableCompassMode();
  }

  // --- Init ---
  // Dropdown
  capitals.forEach((c, i) => {
    const opt = document.createElement("option");
    opt.value = String(i);
    opt.textContent = c.name;
    elCity.appendChild(opt);
  });

  initMap();
  elCity.value = "0";

  // Wire up
  elCity.addEventListener("change", updateUI);
  elLocate.addEventListener("click", locate);
  elFit.addEventListener("click", fitMap);
  elCompassBtn.addEventListener("click", toggleCompass);

  // First render
  updateUI();
})();
</script>
</body>
          </html>
